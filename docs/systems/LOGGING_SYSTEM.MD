# DC20Clean â€“ Logging & Telemetry System

> **Status: WIP** â€“ Implementation pending. See `docs/plannedSpecs/LOGGING_SPEC.md` for full specification.

> Purpose  
> Centralized logging, metrics collection, and error tracking for the DC20 Character Creator.

---

## 1. Overview

The logging system provides:

| Capability             | Service               | Status                        |
| ---------------------- | --------------------- | ----------------------------- |
| **Structured Logging** | Custom Logger Service | ğŸ”„ WIP                        |
| **Usage Metrics**      | Vercel Analytics      | ğŸ”„ WIP                        |
| **Error Tracking**     | Sentry                | ğŸ”„ WIP                        |
| **Server Logs**        | Convex (built-in)     | â³ Pending Convex integration |

---

## 2. Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         React App                               â”‚
â”‚                             â”‚                                   â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚              â–¼              â–¼              â–¼                    â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚       â”‚  Logger  â”‚   â”‚  Vercel  â”‚   â”‚  Sentry  â”‚               â”‚
â”‚       â”‚ Service  â”‚   â”‚ Analyticsâ”‚   â”‚   SDK    â”‚               â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                 â”‚
â”‚       Development:    Production:     Production:               â”‚
â”‚       Console output  Page metrics    Error capture             â”‚
â”‚                       Custom events   Stack traces              â”‚
â”‚                       Web Vitals      User context              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Log Levels

| Level   | Description             | Production          | Development |
| ------- | ----------------------- | ------------------- | ----------- |
| `debug` | Detailed debugging info | âŒ Suppressed       | âœ… Console  |
| `info`  | Operational information | âŒ Suppressed       | âœ… Console  |
| `warn`  | Warning conditions      | âœ… Console          | âœ… Console  |
| `error` | Error conditions        | âœ… Console + Sentry | âœ… Console  |

---

## 4. Log Contexts

Logs are categorized by context for filtering and analysis:

| Context       | Description                    | Key Events                       |
| ------------- | ------------------------------ | -------------------------------- |
| `storage`     | localStorage/Convex operations | Save, load, backup, migration    |
| `calculation` | Character calculation engine   | Calc complete, validation errors |
| `auth`        | Authentication flows           | Sign-in, sign-out, session       |
| `pdf`         | PDF export operations          | Export start, complete, fail     |
| `ui`          | UI interactions                | Stage changes, navigation        |
| `migration`   | Schema migrations              | Version upgrades, field changes  |

---

## 5. Logger API

**File**: `src/lib/utils/logger.ts` (WIP)

```typescript
import { logger } from '@/lib/utils/logger';

// Debug - development only
logger.debug('storage', 'Loading character', { id: characterId });

// Info - operational events
logger.info('ui', 'Character creation complete', { classId, level });

// Warn - recoverable issues
logger.warn('calculation', 'Mastery cap exceeded', { skill, cap });

// Error - failures (sent to Sentry in production)
logger.error('pdf', 'Export failed', { characterId, error: err.message });

// Track custom analytics event
logger.track('pdf_export_completed', { characterId, sizeBytes });
```

---

## 6. Critical Flow Instrumentation

### 6.1 Character Creation

| Event              | Level | Context | Data                              |
| ------------------ | ----- | ------- | --------------------------------- |
| Stage entered      | info  | ui      | `{ stage, characterId }`          |
| Validation warning | warn  | ui      | `{ message, field }`              |
| Creation complete  | info  | ui      | `{ characterId, classId, level }` |
| Creation abandoned | info  | ui      | `{ lastStage, duration }`         |

### 6.2 Character Calculation

| Event                | Level | Context     | Data                   |
| -------------------- | ----- | ----------- | ---------------------- |
| Calculation start    | debug | calculation | `{ classId, level }`   |
| Calculation complete | debug | calculation | `{ durationMs }`       |
| Validation error     | warn  | calculation | `{ code, details }`    |
| Calculation crash    | error | calculation | `{ error, buildData }` |

### 6.3 Storage Operations

| Event             | Level | Context | Data                        |
| ----------------- | ----- | ------- | --------------------------- |
| Characters loaded | info  | storage | `{ count, source }`         |
| Character saved   | info  | storage | `{ characterId, name }`     |
| Migration applied | info  | storage | `{ from, to, characterId }` |
| Parse/save failed | error | storage | `{ error, characterId }`    |

### 6.4 PDF Export

| Event           | Level | Context | Data                         |
| --------------- | ----- | ------- | ---------------------------- |
| Export started  | info  | pdf     | `{ characterId, version }`   |
| Export complete | info  | pdf     | `{ characterId, sizeBytes }` |
| Export failed   | error | pdf     | `{ characterId, error }`     |

### 6.5 Authentication

| Event            | Level | Context | Data                         |
| ---------------- | ----- | ------- | ---------------------------- |
| Sign-in started  | info  | auth    | `{ provider }`               |
| Sign-in success  | info  | auth    | `{ provider }`               |
| Sign-in failed   | error | auth    | `{ provider, error }`        |
| Feature gate hit | info  | auth    | `{ feature, authenticated }` |

---

## 7. Environment Configuration

| Variable                | Description             | Default                       |
| ----------------------- | ----------------------- | ----------------------------- |
| `VITE_LOG_LEVEL`        | Minimum log level       | `warn` (prod) / `debug` (dev) |
| `VITE_SENTRY_DSN`       | Sentry Data Source Name | (disabled if empty)           |
| `VITE_ENABLE_ANALYTICS` | Enable Vercel Analytics | `true`                        |

---

## 8. Metrics & Dashboards

### Vercel Analytics (Usage Metrics)

- Page views and navigation patterns
- Web Vitals (LCP, FID, CLS)
- Custom events (character creation, PDF export)
- Feature usage rates

### Sentry (Error Tracking)

- JavaScript exceptions with stack traces
- Error grouping and trends
- Browser/device context
- Session replay for errors

### Convex Dashboard (Future)

- Server function execution logs
- Query/mutation performance
- Authentication events
- Real-time log streaming

---

## 9. Key Files

| File                                | Purpose                  | Status      |
| ----------------------------------- | ------------------------ | ----------- |
| `src/lib/utils/logger.ts`           | Logger service           | ğŸ”„ WIP      |
| `src/main.tsx`                      | Sentry & Analytics setup | ğŸ”„ WIP      |
| `docs/plannedSpecs/LOGGING_SPEC.md` | Full implementation spec | âœ… Complete |

---

## 10. Related Systems

- **Database & Storage** â€” `docs/systems/DATABASE_SYSTEM.MD`
- **PDF Export** â€” `docs/systems/PDF_EXPORT_SYSTEM.MD`
- **Character Creation** â€” `docs/systems/CHARACTER_CREATION_FLOW.MD`
- **Calculation System** â€” `docs/systems/CALCULATION_SYSTEM.MD`
- **Convex Migration** â€” `docs/plannedSpecs/CONVEX_MIGRATION_SPEC.md`

---

> Last updated: 2026-01-15  
> Status: WIP  
> Maintainer: @DC20Clean-Team
