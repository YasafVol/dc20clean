# Gimli's Memory Bank - Character Sheet Refactor & Effect System Investigation

## Original Problem: Character Sheet Broken (RESOLVED ✅)

- User reports character sheet is broken after recent refactoring
- Calculations were moved out of `CharacterSheetClean.tsx` but UI still references old patterns
- **STATUS**: Fixed routing and Context integration

## Problems Found & Fixed

1. **App.tsx routing issue** ✅ FIXED
2. **CharacterSheetRouter import issues** ✅ FIXED
3. **Missing Context wrapper** ✅ FIXED
4. **TypeScript compilation errors** ✅ FIXED

## New Investigation: Effect System Gaps

### User Question: `restoration_tag` and `mpMax` Usage

**FINDINGS**:

- ✅ **`mpMax` target** - Fully implemented in enhancedCharacterCalculator.ts line 530
- ❌ **`restoration_tag` with GRANT_SPELL** - NOT implemented in calculator
- ❌ **`elemental_tag` with GRANT_SPELL** - NOT implemented in calculator
- ❌ **`holy_tag` with GRANT_CANTRIP** - NOT implemented in calculator

### Effect System Status

**Implemented in Calculator**:

- `MODIFY_STAT` (includes mpMax, hpMax, spMax, pd, ad, moveSpeed, etc.) ✅
- `MODIFY_ATTRIBUTE` ✅
- `GRANT_SKILL_EXPERTISE` ✅
- `GRANT_TRADE_EXPERTISE` ✅
- `GRANT_ABILITY` ✅

**Missing from Calculator**:

- `GRANT_SPELL` ❌
- `GRANT_CANTRIP` ❌
- `GRANT_MANEUVERS` ❌
- `GRANT_TECHNIQUES` ❌

### Key Files for Effect Investigation

- `/src/lib/rulesdata/_new_schema/cleric_features.ts` - Contains GRANT_SPELL effects
- `/src/lib/services/enhancedCharacterCalculator.ts` - Effect processing
- `/src/lib/rulesdata/schemas/character.schema.ts` - Effect type definitions
- `/src/lib/rulesdata/spells-data/spells/holy-and-restoration/` - Actual spell data

### Critical Gap Identified

The cleric's divine domain features grant spells via GRANT_SPELL effects, but the calculator completely ignores these effects. This means:

- Magic domain: `{ type: 'GRANT_SPELL', target: 'restoration_tag', value: 1 }` does nothing
- Life domain: `{ type: 'GRANT_SPELL', target: 'restoration_tag', value: 1 }` does nothing
- Nature domain: `{ type: 'GRANT_SPELL', target: 'elemental_tag', value: 1 }` does nothing

## Latest Update: UserChoice Support in ClassFeatures Component ✅

### User Request: Support userChoice in ClassFeatures Component

**REQUIREMENT**: The ClassFeatures.tsx component needs to support the new `userChoice` mechanism in effects.

**PROBLEM**: The component was only extracting choices from `feature.choices` array but not from individual effects with `userChoice` properties.

**SOLUTION IMPLEMENTED**:

1. **Added Effect Scanning**: Component now scans through `feature.effects` looking for effects with `userChoice` properties
2. **Added Choice Option Effect Scanning**: Also scans through choice option effects for nested `userChoice` properties
3. **Choice ID Generation**: Creates unique choice IDs for userChoice effects
4. **Label Transformation**: Converts snake_case option values to Title Case labels
5. **TypeScript Safety**: Added proper type annotations and casting

**NEW FUNCTIONALITY**:

```typescript
// Scans feature effects for userChoice
if (feature.effects) {
	feature.effects.forEach((effect, effectIndex) => {
		if (effect.userChoice) {
			// Creates choice with ID like: "cleric_cleric_order_effect_0_user_choice"
			const choiceId = `${className}_${featureName}_effect_${effectIndex}_user_choice`;
			// Transforms options: ['fire_tag', 'holy_tag'] → ["Fire Tag", "Holy Tag"]
		}
	});
}
```

**BENEFITS**:

- ✅ Magic domain spell tag choice will now appear in character creation UI
- ✅ Any future userChoice effects will be automatically supported
- ✅ Maintains existing choice system compatibility
- ✅ TypeScript compilation successful
- ✅ Proper unique ID generation prevents conflicts

**REMAINING ISSUES**:

- GRANT_SPELL effects still not processed by calculator (separate architectural issue)
- Need to test actual UI rendering with cleric character creation

## Next Steps

1. Test cleric character creation to verify spell tag choice appears
2. Verify choice selection is properly saved to character state
3. Implement GRANT_SPELL/GRANT_CANTRIP handling in calculator if needed
